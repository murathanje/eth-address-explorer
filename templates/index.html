<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Explorer Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <style>
        :root {
            /* Main Colors */
            --primary-color: #7c3aed;
            --primary-dark: #6d28d9;
            --primary-light: #a78bfa;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            
            /* Background Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #2d3748;
            
            /* Text Colors */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            /* Border Colors */
            --border-color: #334155;
            --border-light: #475569;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #7c3aed, #6d28d9);
            --gradient-card: linear-gradient(145deg, #1e293b, #1e293b80);
            --gradient-hover: linear-gradient(145deg, #2d3748, #2d374880);
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            
            /* Animation */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
        }

        .app-header {
            background: var(--bg-secondary);
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .app-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .eth-price-badge {
            background: var(--gradient-primary);
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: var(--shadow-sm);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .eth-price-badge i {
            font-size: 1.2rem;
        }

        .search-container {
            background: var(--bg-secondary);
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .address-input {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            color: var(--text-primary);
            padding: 1rem 1.25rem;
            font-size: 1rem;
            transition: var(--transition-normal);
        }

        .address-input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
            outline: none;
        }

        .search-btn {
            background: var(--gradient-primary);
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            color: white;
            font-weight: 500;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .search-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .search-btn i {
            margin-right: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: var(--gradient-hover);
            border-color: var(--border-light);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-family: 'Space Grotesk', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .stat-change {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .positive-change {
            color: var(--success-color);
        }

        .negative-change {
            color: var(--danger-color);
        }

        .visualization-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: var(--shadow-md);
        }

        .tab-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: var(--transition-fast);
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .tab-btn.active {
            color: var(--text-primary);
            background: var(--primary-color);
        }

        .network-container {
            height: 600px;
            position: relative;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            overflow: hidden;
            background: var(--bg-primary);
            box-shadow: var(--shadow-lg);
        }

        #network {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        }

        .vis-network:focus {
            outline: none;
        }

        .vis-network .vis-navigation {
            filter: invert(1) hue-rotate(180deg);
        }

        .network-tooltip {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 0.875rem;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            z-index: 1000;
            word-break: break-all;
        }

        .transactions-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 1rem;
            padding-right: 0.5rem;
        }

        .transactions-list::-webkit-scrollbar {
            width: 6px;
        }

        .transactions-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 3px;
        }

        .transactions-list::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        .transaction-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: var(--transition-normal);
            overflow: hidden;
        }

        .transaction-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
            transform: translateX(5px);
        }

        .transaction-hash {
            font-family: 'Space Grotesk', monospace;
            color: var(--primary-light);
            font-size: 0.875rem;
            word-break: break-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .transaction-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-weight: 500;
        }

        .badge-sent {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .badge-received {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .badge-internal {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .node circle {
            transition: var(--transition-normal);
        }

        .node:hover circle {
            filter: brightness(1.2) drop-shadow(0 0 8px rgba(124, 58, 237, 0.5));
        }

        .link {
            transition: var(--transition-normal);
        }

        .link:hover {
            filter: brightness(1.2) drop-shadow(0 0 4px rgba(124, 58, 237, 0.3));
        }

        .loading-overlay {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
            max-width: 90%;
            width: 400px;
            margin: 0 auto;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
        }

        .api-key-container {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2rem;
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .api-key-container h3 {
            color: var(--primary-light);
            margin-bottom: 1rem;
        }

        .api-key-input {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            width: 100%;
            margin-bottom: 1rem;
            transition: var(--transition-normal);
        }

        .api-key-input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
            outline: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .eth-price-badge {
                margin-top: 1rem;
            }
            
            .search-box {
                padding: 1rem;
            }
            
            .visualization-container {
                padding: 1rem;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .interactions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .interaction-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .interaction-header {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .interaction-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .interaction-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: var(--transition-normal);
            cursor: pointer;
            overflow: hidden;
            text-decoration: none;
            display: block;
            color: inherit;
        }

        .interaction-item:hover {
            background: var(--bg-hover);
            transform: translateX(5px);
        }

        .interaction-address {
            color: var(--primary-light);
            font-family: 'Space Grotesk', monospace;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .interaction-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }

        .interaction-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .interaction-count {
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
        }

        .connection-address {
            color: var(--primary-light);
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            display: inline-block;
            vertical-align: bottom;
        }

        .connection-address:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .transaction-hash {
                max-width: 200px;
            }

            .connection-address {
                max-width: 100px;
            }

            .interaction-stats {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .transaction-hash {
                max-width: 150px;
            }

            .connection-address {
                max-width: 80px;
            }
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .chart-header {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        .interaction-date {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .transaction-hash-link {
            text-decoration: none;
            color: inherit;
            display: block;
            transition: var(--transition-normal);
        }

        .transaction-hash-link:hover .transaction-hash {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .interaction-dates {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .interaction-date-list {
            max-height: 100px;
            overflow-y: auto;
            padding-left: 1rem;
            margin-top: 0.25rem;
            border-left: 1px solid var(--border-color);
        }

        .interaction-date-item {
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .converter-box {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .converter-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .converter-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem 0 0 0.75rem;
            font-family: 'Space Grotesk', monospace;
        }

        .converter-input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
            outline: none;
        }

        .converter-symbol {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-left: none;
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-radius: 0 0.75rem 0.75rem 0;
            font-family: 'Space Grotesk', monospace;
        }

        .converter-result {
            color: var(--text-primary);
            font-family: 'Space Grotesk', monospace;
            font-size: 1.25rem;
            font-weight: 500;
        }

        .transaction-date {
            color: var(--text-primary) !important;
        }

        .transaction-direction {
            color: var(--text-primary) !important;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="app-brand">ETH Explorer Pro</div>
                <div class="eth-price-badge animate-pulse">
                    <i class="bi bi-currency-ethereum"></i>
                    <span id="ethPrice">$0.00</span>
                </div>
            </div>
        </div>
    </header>

    <section class="search-container">
        <div class="container">
            <div class="search-box">
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <div class="input-group">
                            <input type="text" id="addressInput" class="form-control address-input" 
                                   placeholder="Enter Ethereum address (0x...)">
                            <button class="btn search-btn" onclick="analyzeAddress()">
                                <i class="bi bi-search"></i>
                                Analyze
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-8 mx-auto">
                        <div class="converter-box">
                            <div class="converter-title">ETH/USD Converter</div>
                            <div class="input-group">
                                <input type="number" id="ethAmount" class="form-control converter-input" 
                                       placeholder="Enter ETH amount" step="0.0001" min="0"
                                       oninput="convertEthToUsd()">
                                <span class="input-group-text converter-symbol">ETH</span>
                            </div>
                            <div class="converter-result mt-2" id="usdResult">
                                ≈ $0.00
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main class="container py-4">
        <div id="apiKeySection" class="api-key-container">
            <h3><i class="bi bi-key-fill me-2"></i>Etherscan API Key Required</h3>
            <p class="text-muted mb-4">Enter your Etherscan API key to start analyzing Ethereum addresses.</p>
            <div class="row">
                <div class="col-md-8 mx-auto">
                    <input type="text" id="apiKeyInput" class="api-key-input" 
                           placeholder="Enter your Etherscan API key">
                    <button class="btn search-btn w-100" onclick="saveApiKey()">
                        <i class="bi bi-check-lg"></i>
                        Save API Key
                    </button>
                </div>
            </div>
        </div>

        <div id="results" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="bi bi-arrow-up-right-circle"></i>
                        Total ETH Sent
                    </div>
                    <div class="stat-value eth-sent" id="totalSent">0 ETH</div>
                    <div class="stat-change" id="totalSentUsd">$0.00</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">
                        <i class="bi bi-arrow-down-left-circle"></i>
                        Total ETH Received
                    </div>
                    <div class="stat-value eth-received" id="totalReceived">0 ETH</div>
                    <div class="stat-change" id="totalReceivedUsd">$0.00</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">
                        <i class="bi bi-wallet2"></i>
                        Net Position
                    </div>
                    <div class="stat-value" id="netPosition">0 ETH</div>
                    <div class="stat-change" id="netPositionUsd">$0.00</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">
                        <i class="bi bi-arrow-left-right"></i>
                        Total Transactions
                    </div>
                    <div class="stat-value" id="totalTx">0</div>
                    <div class="stat-change">
                        Normal: <span id="normalTx">0</span>
                        Internal: <span id="internalTx">0</span>
                    </div>
                </div>
            </div>

            <div class="visualization-container">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('network')">
                        <i class="bi bi-diagram-3"></i>
                        Network Graph
                    </button>
                    <button class="tab-btn" onclick="switchTab('transactions')">
                        <i class="bi bi-list-ul"></i>
                        Recent Transactions
                    </button>
                    <button class="tab-btn" onclick="switchTab('interactions')">
                        <i class="bi bi-people-fill"></i>
                        Top Interactions
                    </button>
                    <button class="tab-btn" onclick="switchTab('stats')">
                        <i class="bi bi-bar-chart"></i>
                        Statistics
                    </button>
                </div>

                <div id="networkTab" class="tab-content">
                    <div class="network-container">
                        <div class="network-tooltip" style="position: absolute; display: none;"></div>
                        <div id="network"></div>
                    </div>
                </div>

                <div id="transactionsTab" class="tab-content" style="display: none;">
                    <div class="transactions-list" id="recentTransactions"></div>
                </div>

                <div id="interactionsTab" class="tab-content" style="display: none;">
                    <div class="interactions-grid">
                        <div class="interaction-card">
                            <div class="interaction-header">
                                <i class="bi bi-arrow-down-circle-fill text-success"></i>
                                Top ETH Received From
                            </div>
                            <div class="interaction-list" id="topSenders"></div>
                        </div>
                        <div class="interaction-card">
                            <div class="interaction-header">
                                <i class="bi bi-arrow-up-circle-fill text-danger"></i>
                                Top ETH Sent To
                            </div>
                            <div class="interaction-list" id="topReceivers"></div>
                        </div>
                        <div class="interaction-card">
                            <div class="interaction-header">
                                <i class="bi bi-arrow-left-right"></i>
                                Most Frequent Interactions
                            </div>
                            <div class="interaction-list" id="topInteractions"></div>
                        </div>
                    </div>
                </div>

                <div id="statsTab" class="tab-content" style="display: none;">
                    <div id="visualization"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border loading-spinner" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="mt-4 mb-2">Analyzing Address</h4>
            <p class="text-muted" id="loadingProgress">Fetching transactions...</p>
        </div>
    </div>

    <script>
        let currentEthPrice = 0;
        let apiKey = localStorage.getItem('etherscan_api_key');

        function formatEth(value) {
            return parseFloat(value).toFixed(4) + ' ETH';
        }

        function formatUsd(ethAmount) {
            const usdValue = ethAmount * currentEthPrice;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(usdValue);
        }

        function updateEthPrice() {
            if (!apiKey) return;
            
            fetch(`/api/address/eth_price?api_key=${encodeURIComponent(apiKey)}`)
                .then(response => {
                    // Check if the response is OK (status in the range 200-299)
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        currentEthPrice = data.price;
                        document.getElementById('ethPrice').textContent = 
                            new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD'
                            }).format(data.price);
                    } else {
                        console.error('Failed to fetch ETH price:', data.error);
                    }
                })
                .catch(error => console.error('Error fetching ETH price:', error));
        }

        // Update ETH price every 5 minutes
        updateEthPrice();
        setInterval(updateEthPrice, 300000);

        function checkApiKey() {
            const apiKeySection = document.getElementById('apiKeySection');
            
            if (!apiKey) {
                apiKeySection.style.display = 'block';
                document.getElementById('results').style.display = 'none';
            } else {
                apiKeySection.style.display = 'none';
                // Show the search container when API key exists
                document.querySelector('.search-container').style.display = 'block';
            }
        }

        function saveApiKey() {
            const newApiKey = document.getElementById('apiKeyInput').value.trim();
            if (!newApiKey) {
                alert('Please enter a valid API key');
                return;
            }
            
            apiKey = newApiKey;
            localStorage.setItem('etherscan_api_key', apiKey);
            checkApiKey();
            updateEthPrice();
            // Show the search container after saving API key
            document.querySelector('.search-container').style.display = 'block';
        }

        // Check API key on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkApiKey();
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address');
            if (address && apiKey) {
                document.getElementById('addressInput').value = address;
                analyzeAddress();
            }
            updateEthPrice();
        });

        function analyzeAddress(skipPushState = false) {
            if (!apiKey) {
                alert('Please enter your Etherscan API key first');
                checkApiKey();
                return;
            }

            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                alert('Please enter an Ethereum address');
                return;
            }

            // Update URL with the address parameter
            if (!skipPushState) {
                const url = new URL(window.location);
                url.searchParams.set('address', address);
                window.history.pushState({}, '', url);
            }

            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingProgress = document.getElementById('loadingProgress');
            loadingOverlay.style.display = 'flex';
            document.getElementById('results').style.display = 'none';

            // Start progress updates
            let dots = '';
            const progressInterval = setInterval(() => {
                dots = dots.length >= 3 ? '' : dots + '.';
                loadingProgress.textContent = 'Fetching transactions' + dots;
            }, 500);
            
            fetch(`/api/address/analyze/${encodeURIComponent(address)}?api_key=${encodeURIComponent(apiKey)}`)
                .then(response => {
                    // Check if the response is OK (status in the range 200-299)
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    clearInterval(progressInterval);
                    loadingOverlay.style.display = 'none';

                    // Check the success flag in the response
                    if (data.success) {
                        const analysis = data.analysis;
                        currentEthPrice = analysis.eth_price;
                        document.getElementById('ethPrice').textContent = 
                            new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD'
                            }).format(currentEthPrice);

                        // Update statistics
                        const totalSent = analysis.total_eth_sent;
                        const totalReceived = analysis.total_eth_received;
                        const netPosition = analysis.net_position;

                        document.getElementById('totalSent').textContent = formatEth(totalSent);
                        document.getElementById('totalSentUsd').textContent = formatUsd(totalSent);

                        document.getElementById('totalReceived').textContent = formatEth(totalReceived);
                        document.getElementById('totalReceivedUsd').textContent = formatUsd(totalReceived);

                        const netPositionEl = document.getElementById('netPosition');
                        netPositionEl.textContent = formatEth(netPosition);
                        document.getElementById('netPositionUsd').textContent = formatUsd(netPosition);
                        netPositionEl.className = 'stat-value ' + (netPosition >= 0 ? 'positive-change' : 'negative-change');

                        // Update transaction counts
                        const normalSummary = analysis.normal_summary || {};
                        const internalSummary = analysis.internal_summary || {};
                        
                        document.getElementById('normalTx').textContent = normalSummary.total_transactions || 0;
                        document.getElementById('internalTx').textContent = internalSummary.total_transactions || 0;
                        document.getElementById('totalTx').textContent = 
                            (normalSummary.total_transactions || 0) + (internalSummary.total_transactions || 0);

                        // Update recent transactions
                        const recentTransactions = document.getElementById('recentTransactions');
                        const allTransactions = [
                            ...data.analysis.normal_transactions.slice(0, 50).map(tx => ({...tx, type: 'normal'})),
                            ...data.analysis.internal_transactions.slice(0, 50).map(tx => ({...tx, type: 'internal'}))
                        ].sort((a, b) => b.timeStamp - a.timeStamp).slice(0, 50);

                        recentTransactions.innerHTML = allTransactions.map(tx => {
                            const value = parseFloat(tx.value) / 1e18;
                            const isSent = tx.from.toLowerCase() === address.toLowerCase();
                            const timestamp = new Date(parseInt(tx.timeStamp) * 1000);
                            const formattedTime = timestamp.toLocaleString();
                            
                            return `
                                <div class="transaction-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="mb-1">
                                                <span class="transaction-badge ${isSent ? 'badge-sent' : 'badge-received'}">
                                                    ${isSent ? 'Sent' : 'Received'}
                                                </span>
                                                <span class="transaction-badge badge-internal">${tx.type}</span>
                                            </div>
                                            <a href="https://etherscan.io/tx/${tx.hash}" 
                                               target="_blank" 
                                               rel="noopener noreferrer" 
                                               class="transaction-hash-link">
                                                <div class="transaction-hash">
                                                    ${tx.hash}
                                                </div>
                                                <div class="text-muted small transaction-date">
                                                    ${formattedTime}
                                                </div>
                                            </a>
                                        </div>
                                        <div class="text-end">
                                            <div class="stat-value ${isSent ? 'negative-change' : 'positive-change'}" 
                                                 title="${formatUsd(value)}">
                                                ${formatEth(value)}
                                            </div>
                                            <div class="small transaction-direction">
                                                ${isSent ? 'To:' : 'From:'} 
                                                <span class="connection-address" 
                                                      onclick="analyzeNewAddress('${isSent ? tx.to : tx.from}')"
                                                      style="cursor: pointer;">
                                                    ${(isSent ? tx.to : tx.from).slice(0, 10)}...
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        // Update top interactions lists
                        const topSenders = document.getElementById('topSenders');
                        const topReceivers = document.getElementById('topReceivers');
                        const topInteractions = document.getElementById('topInteractions');

                        // Sort connections by ETH received (top senders)
                        const sortedBySent = [...data.analysis.connections]
                            .sort((a, b) => b.sent - a.sent)
                            .slice(0, 5);

                        // Sort connections by ETH sent (top receivers)
                        const sortedByReceived = [...data.analysis.connections]
                            .sort((a, b) => b.received - a.received)
                            .slice(0, 5);

                        // Sort connections by total transactions (most frequent)
                        const sortedByCount = [...data.analysis.connections]
                            .sort((a, b) => b.count - a.count)
                            .slice(0, 5);

                        // Render top senders list
                        topSenders.innerHTML = sortedBySent.map(conn => `
                            <a href="https://etherscan.io/address/${conn.address}" 
                               class="interaction-item" 
                               target="_blank" 
                               rel="noopener noreferrer">
                                <div class="interaction-address">${conn.address}</div>
                                <div class="interaction-stats">
                                    <span class="interaction-value" title="${formatUsd(conn.sent)}">
                                        ${formatEth(conn.sent)}
                                    </span>
                                    <span class="interaction-count">${conn.count} tx</span>
                                </div>
                                <div class="interaction-date">
                                    Last interaction: ${formatDate(conn.lastInteraction)}
                                </div>
                            </a>
                        `).join('');

                        // Render top receivers list
                        topReceivers.innerHTML = sortedByReceived.map(conn => `
                            <a href="https://etherscan.io/address/${conn.address}" 
                               class="interaction-item" 
                               target="_blank" 
                               rel="noopener noreferrer">
                                <div class="interaction-address">${conn.address}</div>
                                <div class="interaction-stats">
                                    <span class="interaction-value" title="${formatUsd(conn.received)}">
                                        ${formatEth(conn.received)}
                                    </span>
                                    <span class="interaction-count">${conn.count} tx</span>
                                </div>
                                <div class="interaction-date">
                                    Last interaction: ${formatDate(conn.lastInteraction)}
                                </div>
                            </a>
                        `).join('');

                        // Render most frequent interactions
                        topInteractions.innerHTML = sortedByCount.map(conn => {
                            // Sort transactions by date
                            const dates = conn.dates || [];
                            const sortedDates = dates.sort((a, b) => b - a).slice(0, 5);
                            
                            return `
                            <a href="https://etherscan.io/address/${conn.address}" 
                               class="interaction-item" 
                               target="_blank" 
                               rel="noopener noreferrer">
                                <div class="interaction-address">${conn.address}</div>
                                <div class="interaction-stats">
                                    <span class="interaction-value">
                                        <span class="text-danger" title="${formatUsd(conn.sent)}">↑ ${formatEth(conn.sent)}</span>
                                        <span class="text-success" title="${formatUsd(conn.received)}">↓ ${formatEth(conn.received)}</span>
                                    </span>
                                    <span class="interaction-count">${conn.count} tx</span>
                                </div>
                                <div class="interaction-dates">
                                    <div>Last 5 interactions:</div>
                                    <div class="interaction-date-list">
                                        ${sortedDates.map(date => `
                                            <div class="interaction-date-item">
                                                ${formatDate(date)}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </a>
                        `}).join('');

                        // Create network visualization
                        createNetworkVisualization({
                            address: address,
                            total_transactions: data.analysis.total_transactions,
                            connections: data.analysis.connections
                        });

                        // Create statistics visualization
                        createStatisticsVisualization(data);

                        // Show results
                        document.getElementById('results').style.display = 'block';
                    } else {
                        // Handle unsuccessful response
                        alert(data.error || 'Failed to analyze address');
                    }
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    loadingOverlay.style.display = 'none';
                    console.error('Error:', error);
                    alert('Error analyzing address');
                });
        }

        // Allow pressing Enter to analyze
        document.getElementById('addressInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeAddress();
            }
        });

        function analyzeNewAddress(address) {
            // Update input field with the new address
            document.getElementById('addressInput').value = address;
            // Trigger analysis
            analyzeAddress();
            // Scroll to top smoothly
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address');
            if (address) {
                document.getElementById('addressInput').value = address;
                analyzeAddress(true); // true means don't push state
            } else {
                // Clear results if no address in URL
                document.getElementById('addressInput').value = '';
                document.getElementById('results').style.display = 'none';
            }
        });

        function createNetworkVisualization(data) {
            const container = document.getElementById('network');
            container.innerHTML = '';
            
            const nodes = [{
                id: data.address,
                label: data.address.slice(0, 8) + '...',
                title: `Main Address: ${data.address}\nTotal Transactions: ${data.total_transactions}`,
                color: {
                    background: '#7c3aed',
                    border: '#a78bfa',
                    highlight: {
                        background: '#6d28d9',
                        border: '#a78bfa'
                    },
                    hover: {
                        background: '#6d28d9',
                        border: '#a78bfa'
                    }
                },
                font: {
                    color: '#f8fafc',
                    size: 16,
                    face: 'Space Grotesk'
                },
                size: 50,
                borderWidth: 3,
                borderWidthSelected: 5,
                shadow: {
                    enabled: true,
                    color: 'rgba(124, 58, 237, 0.3)',
                    size: 10,
                    x: 0,
                    y: 0
                }
            }];
            
            const edges = [];
            const addedNodes = new Set([data.address]); // Track added nodes
            
            const maxValue = Math.max(
                ...data.connections.map(conn => Math.max(conn.sent, conn.received))
            );
            
            data.connections.forEach(conn => {
                // Skip if we've already added this node
                if (addedNodes.has(conn.address)) {
                    return;
                }
                
                const totalValue = conn.sent + conn.received;
                const size = 25 + (totalValue / maxValue) * 35;
                
                nodes.push({
                    id: conn.address,
                    label: conn.address.slice(0, 8) + '...',
                    title: `Address: ${conn.address}\nSent: ${formatEth(conn.sent)}\nReceived: ${formatEth(conn.received)}\nTransactions: ${conn.count}`,
                    color: {
                        background: '#4f46e5',
                        border: '#818cf8',
                        highlight: {
                            background: '#4338ca',
                            border: '#818cf8'
                        },
                        hover: {
                            background: '#4338ca',
                            border: '#818cf8'
                        }
                    },
                    font: {
                        color: '#f8fafc',
                        size: 14,
                        face: 'Space Grotesk'
                    },
                    size: size,
                    borderWidth: 2,
                    borderWidthSelected: 4,
                    shadow: {
                        enabled: true,
                        color: 'rgba(79, 70, 229, 0.2)',
                        size: 8,
                        x: 0,
                        y: 0
                    }
                });
                
                addedNodes.add(conn.address); // Mark this node as added
                
                edges.push({
                    from: data.address,
                    to: conn.address,
                    width: 0.5,
                    color: {
                        color: '#818cf8',
                        highlight: '#a78bfa',
                        hover: '#a78bfa',
                        opacity: 0.4
                    },
                    arrows: {
                        to: {
                            enabled: conn.received > 0,
                            scaleFactor: 0.2,
                            type: 'arrow'
                        },
                        from: {
                            enabled: conn.sent > 0,
                            scaleFactor: 0.2,
                            type: 'arrow'
                        }
                    },
                    smooth: {
                        type: 'continuous',
                        roundness: 0.2
                    },
                    shadow: {
                        enabled: false
                    }
                });
            });
            
            const options = {
                nodes: {
                    shape: 'dot',
                    scaling: {
                        min: 25,
                        max: 60
                    },
                    font: {
                        face: 'Space Grotesk'
                    }
                },
                edges: {
                    width: 0.5,
                    smooth: {
                        type: 'continuous',
                        roundness: 0.2
                    },
                    selectionWidth: 1,
                    color: {
                        opacity: 0.4
                    }
                },
                physics: {
                    stabilization: {
                        enabled: true,
                        iterations: 100,
                        updateInterval: 25
                    },
                    barnesHut: {
                        gravitationalConstant: -15000,
                        springConstant: 0.005,
                        springLength: 200,
                        damping: 0.5
                    },
                    minVelocity: 0.75,
                    maxVelocity: 50
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    zoomView: true,
                    dragView: true,
                    hideEdgesOnDrag: true,
                    hideEdgesOnZoom: true
                }
            };
            
            const network = new vis.Network(container, {
                nodes: new vis.DataSet(nodes),
                edges: new vis.DataSet(edges)
            }, options);
            
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const clickedNode = nodes.find(node => node.id === params.nodes[0]);
                    if (clickedNode && clickedNode.id !== data.address) {
                        analyzeNewAddress(clickedNode.id);
                    }
                }
            });
            
            network.on('stabilizationProgress', function(params) {
                const progress = Math.round(params.iterations / params.total * 100);
                if (progress === 100) {
                    network.stopSimulation();
                }
            });
            
            network.once('stabilizationIterationsDone', function() {
                network.setOptions({ physics: false });
            });
            
            network.fit();
        }

        function createStatisticsVisualization(data) {
            const statsContainer = document.getElementById('visualization');
            statsContainer.innerHTML = `
                <div class="stats-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <i class="bi bi-bar-chart"></i>
                            Top Interactions by Volume
                        </div>
                        <div id="ethFlowChart"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <i class="bi bi-pie-chart"></i>
                            Transaction Distribution
                        </div>
                        <div id="txDistributionChart"></div>
                    </div>
                </div>
            `;

            // ETH Flow Chart
            const ethFlowOptions = {
                series: [{
                    name: 'Transaction Volume',
                    data: data.analysis.connections
                        .sort((a, b) => (b.sent + b.received) - (a.sent + a.received))
                        .slice(0, 10)
                        .map(conn => ({
                            x: conn.address.slice(0, 10) + '...',
                            y: parseFloat(conn.sent + conn.received)
                        }))
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    toolbar: {
                        show: false
                    },
                    background: 'transparent',
                    foreColor: '#94a3b8'
                },
                plotOptions: {
                    bar: {
                        borderRadius: 8,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return parseFloat(val).toFixed(2) + ' ETH';
                    },
                    style: {
                        colors: ['#94a3b8']
                    }
                },
                colors: ['#7c3aed'],
                xaxis: {
                    labels: {
                        style: {
                            colors: '#94a3b8',
                            fontSize: '12px'
                        },
                        rotate: -45
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return value.toFixed(2) + ' ETH';
                        },
                        style: {
                            colors: '#94a3b8'
                        }
                    }
                },
                tooltip: {
                    theme: 'dark',
                    y: {
                        formatter: function(value) {
                            return value.toFixed(4) + ' ETH';
                        }
                    }
                },
                grid: {
                    borderColor: '#334155',
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: true
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                }
            };

            const ethFlowChart = new ApexCharts(document.getElementById('ethFlowChart'), ethFlowOptions);
            ethFlowChart.render();

            // Transaction Distribution Chart
            const normalTx = data.analysis.normal_summary.total_transactions || 0;
            const internalTx = data.analysis.internal_summary.total_transactions || 0;

            const txDistributionOptions = {
                series: [normalTx, internalTx],
                chart: {
                    type: 'donut',
                    height: 350,
                    background: 'transparent',
                    foreColor: '#94a3b8'
                },
                labels: ['Normal Transactions', 'Internal Transactions'],
                colors: ['#7c3aed', '#4f46e5'],
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%',
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total',
                                    formatter: function(w) {
                                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    }
                                }
                            }
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val, opts) {
                        return opts.w.config.series[opts.seriesIndex];
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        colors: '#94a3b8'
                    }
                },
                tooltip: {
                    theme: 'dark'
                }
            };

            const txDistributionChart = new ApexCharts(document.getElementById('txDistributionChart'), txDistributionOptions);
            txDistributionChart.render();
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'No date available';
            
            try {
                const date = new Date(parseInt(timestamp) * 1000);
                if (isNaN(date.getTime())) return 'No date available';
                
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            } catch (e) {
                return 'No date available';
            }
        }

        function convertEthToUsd() {
            const ethAmount = parseFloat(document.getElementById('ethAmount').value) || 0;
            const usdValue = ethAmount * currentEthPrice;
            document.getElementById('usdResult').textContent = 
                '≈ ' + new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(usdValue);
        }
    </script>
</body>
</html> 